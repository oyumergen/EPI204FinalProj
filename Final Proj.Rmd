---
title: "Final Project"
output:
  html_document: default
  pdf_document: default
date: "2025-04-25"
---

```{r}
if (!require("dplyr")) install.packages("dplyr")
if (!require("skimr")) install.packages("skimr")
if (!require("tidyr")) install.packages("tidyr")
if (!require("survival")) install.packages("survival")
if (!require("survminer")) install.packages("survminer")
if (!require("haven")) install.packages("haven")
if (!require("broom")) install.packages("broom")
if (!require("rms")) install.packages("rms")
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("tableone")) install.packages("tableone")

library(dplyr)
library(skimr)
library(tidyr)
library(survival)
library(survminer)
library(haven)
library(broom)
library(rms)
library(tidyverse) 
library(tableone)
NHANES2 <- read.csv("NHANES2-1 (1).csv")
d <- NHANES2 #%>% 
  #select('ROWNAMES','SEX','RACE','MARRY','DEATH','AGEYRS',
                    #'GRADES','WT', 'BOOZE', 'SIZE',
         #'AVGSMK', "HEIGHT", "EXAM_YR", "DIE_YR", "LAST_YR")
```

```{r}
#Exclude missing death 
d <- d %>%
  filter(!is.na(BOOZE), !is.na(DEATH), !is.na(SEX), !is.na(RACE), !is.na(GRADES), !is.na(MARRY), !is.na(AVGSMK), !is.na(SIZE), !is.na(GRADES))

#BMI
d <- d %>%
  mutate(BMI = WT / (HEIGHT / 100)^2)

head(d$BMI)

# GRADES and SIZE categories
d$EDUC_CAT <- cut(d$GRADES,
                  breaks = c(-Inf, 8, 11, 12, 15, Inf),
                  labels = c("≤8 yrs", "Some HS", "HS Grad", "Some College", "College+"),
                  right = TRUE)

d$SIZE_CAT <- cut(d$SIZE,
                  breaks = c(0, 3, 5, 7, 8),
                  labels = c("Rural", "Small town", "Medium city", "Large city"),
                  right = TRUE)

# Catergorical BOOZE
d <- d %>%
  mutate(BOOZE_q = cut(
    BOOZE,
    breaks = c(-1, 0, 0.5, 2.0, 77.0),
    include.lowest = TRUE,
    labels = c("0/week", "0–0.5/week", "0.5–2/week", ">2/week")
  ))

vars <- c("AGEYRS", "SEX", "RACE", "MARRY", "BMI", "AVGSMK", "EDUC_CAT", "SIZE_CAT")
catVars <- c("SEX", "RACE", "MARRY")

#Table 1

table1 <- CreateTableOne(vars = vars, 
                         data = d, 
                         strata = "BOOZE_q",  
                         factorVars = catVars)

print(table1, showAllLevels = TRUE)

```

```{r}
#Create follow-up time
d$start <- d$EXAM_YR + d$EXAM_MO / 12


d$end <- ifelse(d$DEATH == 1,
                      d$DIE_YR + d$DIE_MO / 12,
                      d$LAST_YR + d$LAST_MO / 12)

d$FU <- d$end - d$start

#Adjusted Cox regression with SEX
cox <- coxph(Surv(FU, DEATH) ~ as.factor(BOOZE_q) + SEX + 
               as.factor(RACE) + as.factor(GRADES) + as.factor(MARRY) + BMI + 
               AVGSMK + SIZE, data = d, ties='efron')
summary(cox)
cox.zph(cox)
plot(cox.zph(cox))

#Product term with SEX Cox regression
cox_product <- coxph(Surv(FU, DEATH) ~ as.factor(BOOZE_q)*SEX + 
                     as.factor(RACE) + as.factor(GRADES) + as.factor(MARRY) + 
                     BMI + AVGSMK + SIZE, data = d, ties = "efron")
summary(cox_product)
cox.zph(cox_product)
plot(cox.zph(cox_product))

#Kaplan
fit<-survfit(Surv(FU, DEATH)~BOOZE_q, data=d)
summary(fit)
summary(fit)$table

#Log-rank test
survdiff(Surv(FU, DEATH)~BOOZE_q, data=d) 
```

